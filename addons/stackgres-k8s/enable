#!/usr/bin/env python3
# addons/stackgres/enable

import os
import subprocess

import click

HELM = '/snap/bin/microk8s.helm3'
ENABLE = '/snap/bin/microk8s.enable'
AD_NAME = 'stackgres-k8s'
CHART_VERSION = '1.4.3'

OPTIONS = [
    '--set', 'grafana.autoEmbed=true',
    '--set-string', 'grafana.webHost=prometheus-operator-grafana.monitoring',
    '--set-string', 'grafana.secretNamespace=monitoring',
    '--set-string', 'grafana.secretName=prometheus-operator-grafana',
    '--set-string', 'grafana.secretUserKey=admin-user',
    '--set-string', 'grafana.secretPasswordKey=admin-password',
]


@click.option('--embed-prometheus', is_flag=True, help='to use prometheus or not')
@click.command()
def main(embed_prometheus):
    click.echo(f'Enabling {AD_NAME}')

    # enable dns
    subprocess.check_call([
        ENABLE, 'dns'
    ])

    if embed_prometheus:
        click.echo('Enabling prometheus')
        # enable prometheus
        subprocess.check_call([
            ENABLE, 'prometheus-k8s'
        ])

    # add stackgres helm repo
    subprocess.check_call([
        HELM, 'repo', 'add', 'stackgres-charts',
        'https://stackgres.io/downloads/stackgres-k8s/stackgres/helm/'
    ])

    # update repo
    subprocess.check_call([
        HELM, 'repo', 'update'
    ])

    cmd = [
        HELM, 'install',
        '--create-namespace', '--namespace', 'stackgres',
        'stackgres-operator',
    ]
    if embed_prometheus:
        for option in OPTIONS:
            cmd.append(option)
    for option in ['--version', CHART_VERSION,
                   'stackgres-charts/stackgres-operator',
                   '--set-string', 'adminui.service.type=ClusterIP']:
        cmd.append(option)

    # install chart
    subprocess.check_call(cmd)
    click.echo(f'Enabled {AD_NAME}')


if __name__ == '__main__':
    main()
